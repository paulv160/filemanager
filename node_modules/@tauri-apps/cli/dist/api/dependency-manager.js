import{b as t,_ as e,a as n,c as r}from"../tslib.es6-753a81cf.js";import{l as a}from"../logger-27e93e7d.js";import{spawnSync as i}from"../helpers/spawn.js";import{sync as s}from"cross-spawn";import{downloadRustup as o}from"../helpers/download-binary.js";import{existsSync as u,readFileSync as c,writeFileSync as l}from"fs";import{dirname as p,resolve as d}from"path";import{platform as f}from"os";import"https";import{fileURLToPath as g}from"url";import{a as v,r as m,t as h}from"../app-paths-46150e8b.js";import w from"inquirer";import{createRequire as y}from"module";import"chalk";import"ms";import"util";import"stream";import"global-agent";var b;!function(t){t[t.Install=0]="Install",t[t.InstallDev=1]="InstallDev",t[t.Update=2]="Update"}(b||(b={}));var k=p(g(import.meta.url)),I=a("dependency:rust");function P(){return e(this,void 0,void 0,(function(){var t,e;return n(this,(function(n){switch(n.label){case 0:return t="win32"===f()?"rustup-init.exe":"rustup-init.sh",e=d(k,"../../bin/"+t),u(e)?[3,2]:[4,o()];case 1:n.sent(),n.label=2;case 2:return"win32"===f()?[2,i("powershell",["-NoProfile",e],process.cwd())]:[2,i("/bin/sh",[e],process.cwd())]}}))}))}function S(r){return e(this,void 0,void 0,(function(){return n(this,(function(e){switch(e.label){case 0:return null!==function(e,n){void 0===n&&(n=[]);try{var r=s(e,t(t([],n),["--version"]));return 0===r.status?String(r.output[1]).replace(/\n/g,""):null}catch(t){return null}}("rustup")?[3,2]:(I("Installing rustup..."),[4,P()]);case 1:e.sent(),e.label=2;case 2:return r===b.Update&&i("rustup",["update"],process.cwd()),[2]}}))}))}function U(){return e(this,void 0,void 0,(function(){return n(this,(function(t){switch(t.label){case 0:return[4,S(b.Install)];case 1:return[2,t.sent()]}}))}))}function D(){return e(this,void 0,void 0,(function(){return n(this,(function(t){switch(t.label){case 0:return[4,S(b.Update)];case 1:return[2,t.sent()]}}))}))}var x=function(){function t(){this.type="yarn"}return t.prototype.installPackage=function(t){i("yarn",["add",t],v)},t.prototype.installDevPackage=function(t){i("yarn",["add",t,"--dev"],v)},t.prototype.updatePackage=function(t){i("yarn",["upgrade",t,"--latest"],v)},t.prototype.getPackageVersion=function(t){var e=s("yarn",["list","--pattern",t,"--depth","0"],{cwd:v}),n=String(e.output[1]),r=new RegExp(t+"@(\\S+)","g").exec(n);return(null==r?void 0:r[1])?r[1]:null},t.prototype.getLatestVersion=function(t){var e=s("yarn",["info",t,"version","--json"],{cwd:v}),n=String(e.output[1]);return JSON.parse(n).data},t}(),V=function(){function t(){this.type="npm"}return t.prototype.installPackage=function(t){i("npm",["install",t],v)},t.prototype.installDevPackage=function(t){i("npm",["install",t,"--save-dev"],v)},t.prototype.updatePackage=function(t){i("npm",["install",t+"@latest"],v)},t.prototype.getPackageVersion=function(t){var e=s("npm",["list",t,"version","--depth","0"],{cwd:v}),n=String(e.output[1]),r=new RegExp(t+"@(\\S+)","g").exec(n);return(null==r?void 0:r[1])?r[1]:null},t.prototype.getLatestVersion=function(t){var e=s("npm",["show",t,"version"],{cwd:v});return String(e.output[1]).replace("\n","")},t}(),j=function(){function t(){this.type="pnpm"}return t.prototype.installPackage=function(t){i("pnpm",["add",t],v)},t.prototype.installDevPackage=function(t){i("pnpm",["add",t,"--save-dev"],v)},t.prototype.updatePackage=function(t){i("pnpm",["add",t+"@latest"],v)},t.prototype.getPackageVersion=function(t){var e=s("pnpm",["list",t,"version","--depth","0"],{cwd:v}),n=String(e.output[1]),r=new RegExp(t+" (\\S+)","g").exec(n);return(null==r?void 0:r[1])?r[1]:null},t.prototype.getLatestVersion=function(t){var e=s("pnpm",["info",t,"version"],{cwd:v});return String(e.output[1]).replace("\n","")},t}(),C=function(){return u(m.app("yarn.lock"))?new x:u(m.app("pnpm-lock.yaml"))?new j:new V};function E(t){var e=s("cargo",["search",t,"--limit","1"]),n=String(e.output[1]),r=new RegExp(t+' = "(\\S+)"',"g").exec(n);return(null==r?void 0:r[1])?r[1]:null}function R(t,e){return t!==e}var L=y(import.meta.url)("@tauri-apps/toml"),M=a("dependency:crates"),N=["tauri"];function q(t){if(u(t)){var e=c(t).toString();return L.parse(e)}return null}function A(t,e){return"string"==typeof t?e:r(r({},t),{version:e})}function J(r){return e(this,void 0,void 0,(function(){var e,a,s,o,c,p,d,f,g,v;return n(this,(function(y){switch(y.label){case 0:if(e=[],a=[],s=new Map,null===(o=q(m.tauri("Cargo.toml"))))return M("Cargo.toml not found. Skipping crates check..."),[2,s];c=m.tauri("Cargo.lock"),u(c)||i("cargo",["generate-lockfile"],h),p=q(c),d=function(t){var i,s,u,c;return n(this,(function(n){switch(n.label){case 0:return i=p?p.package.filter((function(e){return e.name===t})):[],s=o.dependencies[t],void 0!==(u=1===i.length?i[0].version:"string"==typeof s?s:null==s?void 0:s.version)?[3,1]:(M("Installing "+t+"..."),null!==(c=E(t))&&(o.dependencies[t]=A(o.dependencies[t],c)),e.push(t),[3,6]);case 1:return r!==b.Update?[3,5]:null===(c=E(t))?[3,4]:R(u,c)?[4,w.prompt([{type:"confirm",name:"answer",message:'[CRATES] "'+t+'" latest version is '+c+". Do you want to update?",default:!1}])]:[3,3];case 2:return n.sent().answer&&(M("Updating "+t+"..."),o.dependencies[t]=A(o.dependencies[t],c),a.push(t)),[3,4];case 3:o.dependencies[t]=A(o.dependencies[t],c),a.push(t),M('"'+t+'" is up to date'),n.label=4;case 4:return[3,6];case 5:M('"'+t+'" is already installed'),n.label=6;case 6:return[2]}}))},f=0,g=N,y.label=1;case 1:return f<g.length?(v=g[f],[5,d(v)]):[3,4];case 2:y.sent(),y.label=3;case 3:return f++,[3,1];case 4:return(e.length||a.length)&&l(m.tauri("Cargo.toml"),L.stringify(o)),a.length&&(u(m.tauri("Cargo.lock"))||i("cargo",["generate-lockfile"],h),i("cargo",t(["update","--aggressive"],a.reduce((function(e,n){return t(t([],e),["-p",n])}),[])),h)),s.set(b.Install,e),s.set(b.Update,a),[2,s]}}))}))}function O(){return e(this,void 0,void 0,(function(){return n(this,(function(t){switch(t.label){case 0:return[4,J(b.Install)];case 1:return[2,t.sent()]}}))}))}function T(){return e(this,void 0,void 0,(function(){return n(this,(function(t){switch(t.label){case 0:return[4,J(b.Update)];case 1:return[2,t.sent()]}}))}))}var _=a("dependency:npm-packages");function z(t,r){var a,i,o;return e(this,void 0,void 0,(function(){var e,c,l,p,d,f,g,v,h,y,k,I,P;return n(this,(function(n){switch(n.label){case 0:if(e=[],c=[],l=s("npm",["--version"]),p=s("yarn",["--version"]),d=s("pnpm",["--version"]),(null!==(a=l.status)&&void 0!==a?a:l.error)&&(null!==(i=p.status)&&void 0!==i?i:p.error)&&(null!==(o=d.status)&&void 0!==o?o:d.error))throw new Error("must have installed one of the following package managers `npm`, `yarn`, `pnpm` to manage dependenices");if(!u(m.app("package.json")))return[3,10];f=0,g=r,n.label=1;case 1:return f<g.length?(v=g[f],S=v,h=C().getPackageVersion(S),y=C().type.toUpperCase(),null!==h?[3,4]:(_("Installing "+v+"..."),t!==b.Install&&t!==b.InstallDev?[3,3]:(k=t===b.InstallDev?" as dev-dependency":"",[4,w.prompt([{type:"confirm",name:"answer",message:"["+y+']: "Do you want to install '+v+k+'?"',default:!1}])]))):[3,10];case 2:n.sent().answer&&(t===b.Install?function(t){C().installPackage(t)}(v):t===b.InstallDev&&function(t){C().installDevPackage(t)}(v),e.push(v)),n.label=3;case 3:return[3,9];case 4:return t!==b.Update?[3,8]:(I=function(t){return C().getLatestVersion(t)}(v),R(h,I)?[4,w.prompt([{type:"confirm",name:"answer",message:"["+y+']: "'+v+'" latest version is '+I+". Do you want to update?",default:!1}])]:[3,6]);case 5:return n.sent().answer&&(_("Updating "+v+"..."),function(t){C().updatePackage(t)}(v),c.push(v)),[3,7];case 6:_('"'+v+'" is up to date'),n.label=7;case 7:return[3,9];case 8:_('"'+v+'" is already installed'),n.label=9;case 9:return f++,[3,1];case 10:return(P=new Map).set(b.Install,e),P.set(b.Update,c),[2,P]}var S}))}))}var B=["@tauri-apps/api","@tauri-apps/cli"];function F(){return e(this,void 0,void 0,(function(){return n(this,(function(t){switch(t.label){case 0:return[4,z(b.Install,B)];case 1:return[2,t.sent()]}}))}))}function G(){return e(this,void 0,void 0,(function(){return n(this,(function(t){switch(t.label){case 0:return[4,z(b.Update,B)];case 1:return[2,t.sent()]}}))}))}var H=a("dependency:manager");function K(){return e(this,void 0,void 0,(function(){return n(this,(function(t){switch(t.label){case 0:return H("Installing missing dependencies..."),[4,U()];case 1:return t.sent(),[4,O()];case 2:return t.sent(),[4,F()];case 3:return t.sent(),[2]}}))}))}function Q(){return e(this,void 0,void 0,(function(){return n(this,(function(t){switch(t.label){case 0:return H("Updating dependencies..."),[4,D()];case 1:return t.sent(),[4,T()];case 2:return t.sent(),[4,G()];case 3:return t.sent(),[2]}}))}))}export{K as installDependencies,Q as updateDependencies};
